<div class="container">
  <div class="table-container">
    <div class="results mt-3 mb-5"><%= @rule.size %> normas registradas no sistema</div>
      <div id="data">
        <table class="table">
          <thead class="thead-light">
            <% if @rule.size.positive? %>
              <tr>
                <th scope="col">Jurisdi√ß√£o</th>
                <th scope="col">Emissor</th>
                <th scope="col">Categoria</th>
                <th scope="col">N√∫mero</th>
                <th scope="col">Data de Publica√ß√£o</th>
                <th scope="col">Data de Edi√ß√£o</th>
                <th scope="col">Ementa</th>
                <th scope="col">Fonte</th>
                <th scope="col">Origem da Norma</th>
                <th scope="col">Avalia√ß√£o</th>
                <th scope="col">Vig√™ncia</th>
                <th scope="col">Detalhar</th>
                 <th scope="col">Detalhar2</th>
                <th scope="col">Link oficial</th>
              </tr>
            </thead>
            <tbody>
            <% @rule.each do |rule| %>
              <tr>
                <td class="text-center"><%= rule.jurisdiction %></td>
                <td><%= rule.issuer %></td>
                <td><%= rule.category %></td>
                <td><%= rule.number %></td>
                <td><%= format_date(rule.pub_date) %></td>
                <td><%= format_date(rule.ed_date) %></td>
                <td><%= rule.long_title.truncate_words(10) %></td>
                <td><%= rule.source %></td>

                <td class="text-center"><%= rule.user.first_name %></td>

                <% grade_count = 0 %>
                <% rule.ratings.each {|rating| grade_count = grade_count + rating.grade if !rating.grade.nil?} %>
                <td><%= grade_count %><%= grade_count >= 0 ? " üëç" : " üëé"  %></td>

                <% validity_count = 0 %>
                <% rule.ratings.each {|rating| validity_count = validity_count + rating.validity if !rating.validity.nil?} %>
                <td><%= validity_count %><%= validity_count >= 0 ? " üëç" : " üëé"  %> </td>
                
                <td class="text-center"> 
                  <%= link_to "https://cella-gis.herokuapp.com/rules/#{rule.id}", :target => "_blank" do %>
                    <i class="fas fa-search"></i>
                  <% end %>
                </td>
                <td class="text-center"> 
                  <%= link_to rule_path(rule.id), :target => "_blank" do %>
                    <i class="fas fa-search"></i>
                  <% end %>
                </td>
                <td class="text-center">
                  <%= link_to rule.hyperlink, :target => "_blank" do %>
                    <i class="fas fa-external-link-alt mr-3"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
            <% else %>
              <p class="title">N√£o foram encontrados resultados para essa busca</p>
            <% end %>
            </tbody>
        </table>
      </div>
    <div class="item-a">
      <button class="br-button primary" onclick="exportDataToExcel('data')">Baixar arquivo</button>
      <%= link_to 'Voltar', :back, class: "br-button secondary ml-1" %>
    </div>
  </div>
</div>

<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="//cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function(){
    $('.table').DataTable({
        "language": {
              "lengthMenu": "Mostrando _MENU_ registros por p√°gina",
              "zeroRecords": "Nada encontrado",
              "info": "Mostrando p√°gina _PAGE_ de _PAGES_",
              "infoEmpty": "Nenhum registro dispon√≠vel",
              "infoFiltered": "(filtrado de _MAX_ registros no total)",
              "sSearch" : "Filtrar",
              "oPaginate": {
                      "sFirst":    "Primeira",
                      "sPrevious": "Anterior",
                      "sNext":     "Pr√≥xima",
                      "sLast":     "√öltima"
                    }
          }
      });
});
</script>

<script>
      function exportDataToExcel(data, filename = '')
       {
          var downloadurl;
          var fileType = 'application/vnd.ms-excel';
          var tableSelect = document.getElementById(data);
          var dataHTML = tableSelect.outerHTML.replace(/ /g, '%20');
          filename = filename?filename+'.xls':'user_details.xls';
          downloadurl = document.createElement("a");
          document.body.appendChild(downloadurl);
         if(navigator.msSaveOrOpenBlob)
           {
              var blob = new Blob(['\ufeff', dataHTML],
               {
                  type:  fileType
              });
             navigator.msSaveOrOpenBlob( blob, filename);
           }
        else
          {
           downloadurl.href = 'data:' + fileType + ', ' + dataHTML;
           downloadurl.download = filename;
          downloadurl.click();
       }
    }
</script>
